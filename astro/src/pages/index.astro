---
import Layout from "../layouts/Layout.astro";
import UpcomingShows from "../components/UpcomingShows.astro";
import BandInfo from "../components/BandInfo.astro";
import { RandomSnacksVid } from "../components/RandomSnacksVid";
import { sanityAPI, sanityImageUrl } from "../utils/sanity";
import type { SnacksVid, BannerImage } from "../types";
import Music from "../components/Music.astro";

const bannerResult = await sanityAPI("banner");
const banners = bannerResult.result;
const banner = banners[0] as BannerImage;

const vidResult = await sanityAPI("videos");
const snacksVids = vidResult.result as SnacksVid[];

const builder = sanityImageUrl(banner.image);
---

<Layout title="Nasty Snacks">
  <main class="flex flex-col relative">
    <div
      class="md:h-[100vh] -z-40 overflow-hidden opacity-40 -translate-y-[64px]"
    >
      <img
        alt={banner.alt}
        src={builder.auto("format").url()}
        height="1000px"
        width="1500px"
      />
    </div>

    <!-- Scroll Prompt -->
    <span
      id="scrollPrompt"
      class="fixed left-[50%] right-[50%] bottom-12 opacity-0 transition duration-700 ease-in-out translate-y-6"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="1.5"
        stroke="currentColor"
        class="w-8 h-8"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M19.5 5.25l-7.5 7.5-7.5-7.5m15 6l-7.5 7.5-7.5-7.5"></path>
      </svg>
    </span>

    <!-- Upcoming Shows -->
    <section id="shows" class="scroll-m-48">
      <UpcomingShows />
    </section>

    <!-- Music -->
    <section id="music" class="opacity-0 transition duration-1000 ease-in-out pt-20">
      <h2 class="text-3xl p-4">MUSIC</h2>
      <Music />
    </section>

    <!-- Video -->
    <section id="video" class="opacity-0 transition duration-1000 ease-in-out">
      <h2 class="text-3xl p-4">VIDEO</h2>
      <RandomSnacksVid snacksVids={snacksVids} client:idle />
    </section>

    <!-- Band info -->
    <section id="band">
      <BandInfo />
    </section>

    <!-- Go to top -->
    <button name="scroll to top of page" id="toTop" class="p-2 opacity-0 transition duration-700 ease-in-out fixed bottom-6 right-6">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="currentColor"
        class="w-12 h-12"
      >
        <path
          fill-rule="evenodd"
          d="M11.47 7.72a.75.75 0 011.06 0l7.5 7.5a.75.75 0 11-1.06 1.06L12 9.31l-6.97 6.97a.75.75 0 01-1.06-1.06l7.5-7.5z"
          clip-rule="evenodd"></path>
      </svg>
    </button>
  </main>
</Layout>
<script>
  const prompt = document.getElementById("scrollPrompt");
  const top = document.getElementById("toTop");

  const fadeInScrollPrompt = () => {
    if (!prompt) return;
    setTimeout(() => {
      if (document.body.scrollTop === 0) {
        prompt.classList.add("opacity-100");
        prompt.classList.remove("translate-y-6");
      }
    }, 2000);
  };

  const hideScrollPrompt = () => {
    if (!prompt) return;
    if (window.scrollY !== 0) {
      prompt.classList.remove('opacity-100')
    }
  }

  const swapScrollPrompts = () => {
    if (!prompt || !top) return;
    window.addEventListener('scroll', () => {
      if (window.scrollY === 0) {
        top.classList.add('opacity-0')
        fadeInScrollPrompt()
      } else {
        top.classList.remove('opacity-0')
        prompt.classList.add('opacity-0')
        hideScrollPrompt()
      }
    })
  }

  const showVideo = () => {
    const video = document.getElementById("video");
    const options = {
      threshold: 0.2,
      rootMargin: "-100px",
    };
    if (!video) return;
    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          entry.target.classList.add("opacity-100");
        } else {
          entry.target.classList.remove("opacity-100");
        }
      });
    }, options);
    observer.observe(video);
  };

  const toTop = () => {
    if (!top) return;
    if (document.body.scrollTop === 0) {
      top.classList.add('opacity-0')
    }
    top.addEventListener(
      "click",
      () => {
        window.scrollTo(0, 0);
      },
      { passive: true }
    );
  };
  fadeInScrollPrompt();
  swapScrollPrompts();
  toTop();
  showVideo();
</script>
